#!/usr/bin/env bash
set -ex

# Print compute node.
echo "$(date): Running on compute node $host"

. $LMOD_PKG/init/sh
ml purge
ml gentoo Blender

echo "$(date): Started blender"
echo ""
output=$(dirname "<%= context.working_file %>")/out

<% if context.render_engine == "CYCLES"%>
  <% if context.gpus_per_node.to_i > 0 %>
    srun --export=ALL blender -E "<%= context.render_engine %>" -b "<%= context.working_file %>" -o "${output}" -a -- --cycles-print-stats --cycles-device OPTIX
  <% else %>
    srun --export=ALL blender -E "<%= context.render_engine %>" -b "<%= context.working_file %>" -o "${output}" -a -- --cycles-device CPU
  <% end %>
<% else %>
  srun --export=ALL blender -E "<%= context.render_engine %>" -b "<%= context.working_file %>" -o "${output}" -a
<% end %>

#!/usr/bin/env bash
set -ex

# Print compute node.
echo "$(date): Running on compute node $host"

. $LMOD_PKG/init/sh
ml purge
ml gentoo Blender OpenEXR

cat << END > ./frames_per_node.py
import bpy
import math

scene = bpy.context.scene
print(int(math.ceil((scene.frame_end - scene.frame_start + 1)/float(${SLURM_JOB_NUM_NODES}))))
END

cat << END > ./start_frame.py
import bpy
import math

scene = bpy.context.scene
print(scene.frame_start)
END

cat << END > ./end_frame.py
import bpy
import math

scene = bpy.context.scene
print(scene.frame_end)
END

start_frame=$(blender -b "<%= context.working_file %>" -P ./start_frame.py)
end_frame=$(blender -b "<%= context.working_file %>" -P ./end_frame.py)
frames_per_node=$(blender -b "<%= context.working_file %>" -P ./frames_per_node.py)

if [[ "$frames_per_node" -lt "$SLURM_JOB_NUM_NODES" ]]; then
  echo "The job has stopeed to avoid overconsumption."
  echo "Please use $frames_per_node instead of ${SLURM_JOB_NUM_NODES} nodes."
  exit 1
fi

echo "$(date): Started blender"
echo ""

for node in $(seq 1 "${SLURM_JOB_NUM_NODES}"); do
start_frame_i=$(((node-1)*frames_per_node+start_frame))
end_frame_i=$((node*frames_per_node+start_frame-1))

if [[ node -eq ${SLURM_JOB_NUM_NODES} ]]; then
  end_frame_i=$end_frame
fi

<% if context.render_engine == "CYCLES" %>
<% if context.gpus_per_node.to_i > 0 %>
  srun --export=ALL blender -E "<%= context.render_engine %>" -b "<%= context.working_file %>" -F "<%= context.output_types %>" -o "$(pwd)/out/frame_#####" -s "$start_frame_i" -e "$end_frame_i" -a -- --cycles-print-stats --cycles-device OPTIX &
<% else %>
  srun --export=ALL blender -E "<%= context.render_engine %>" -b "<%= context.working_file %>" -F "<%= context.output_types %>" -o "$(pwd)/out/frame_#####" -s "$start_frame_i" -e "$end_frame_i" -a -- --cycles-print-stats --cycles-device CPU &
<% end %>

<% else %>
  srun --export=ALL blender -E "<%= context.render_engine %>" -b "<%= context.working_file %>" -F "<%= context.output_types %>" -o "$(pwd)/out/frame_#####" -s "$start_frame_i" -e "$end_frame_i" -a &
<% end %>
done

wait
